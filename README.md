# RADIO WAZOO

## Prerequisites

- ESP-IDF v5.0 or later installed and configured
- Node.js 16+ with npm
- Serial port access (user in `dialout` or `uucp` group on Linux)

## Quick Start

### 1. ESP-IDF Environment

Source the ESP-IDF environment in your terminal:

```bash
. $HOME/esp/esp-idf/export.sh
```

Or if you have `IDF_PATH` set:
```bash
. $IDF_PATH/export.sh
```

You need to do this in every new terminal session before running `idf.py` commands.

### 2. Partition Table Setup

The project includes partition table templates for different flash sizes. Choose one based on your ESP32 module:

**Create your partition table:**
```bash
cp partitions_4MB.csv partitions.csv  # For 4MB flash (most common)
```

**Available templates:**
- `partitions_2MB.csv` - 1.28MB app, 704KB storage
- `partitions_4MB.csv` - 1.5MB app, 2.4MB storage
- `partitions_8MB.csv` - 2MB app, 5.9MB storage
- `partitions_16MB.csv` - 3MB app, 13MB storage

Customize `partitions.csv` for your project needs (e.g., adjust storage size for web assets). The file is gitignored as it's project-specific.

### 3. Target Configuration

The project uses ESP-IDF's automatic config merging for multi-target support:

**Set your target chip:**
```bash
idf.py set-target esp32s2  # or esp32, esp32s3, esp32c3, etc.
```

**Configuration files:**
- `sdkconfig.defaults` - Universal settings (all chips)
- `sdkconfig.defaults.esp32s2` - ESP32-S2 specific (USB CDC console)

ESP-IDF automatically merges the appropriate chip-specific config. To add support for other chips, create `sdkconfig.defaults.<chip>` files.

### 4. Building Web Assets

The web interface files need to be compiled and minified before being flashed to the device.

1. **Install Node.js dependencies:**
   ```bash
   npm install
   ```
   This installs Gulp (task runner), esbuild (JavaScript bundler), Sass (SCSS compiler), and other build tools.

2. **Build the web assets:**
   ```bash
   npx gulp
   ```
   This processes files from `src/www/` and outputs compiled versions to `data/www/`.

   **Available tasks:**
   - `npx gulp` or `npx gulp build` - Full build (clean + compile all assets)
   - `npx gulp clean` - Remove build directory
   - `npx gulp scss` - Compile SCSS only
   - `npx gulp js` - Bundle JavaScript only
   - `npx gulp html` - Process HTML with path corrections
   - `npx gulp images` - Copy images only
   - `npx gulp watch` - Auto-rebuild on file changes (development mode)

**Build output:**
- `main.min.css` - 69KB (PicoCSS framework compiled and minified)
- `main.min.js` - 46KB (Alpine.js + persist plugin bundled and minified)
- `index.html` - HTML with corrected asset paths
- Images copied to `assets/images/`

**Note about the data/ directory:**
- `data/` is the root directory for the device's filesystem
- `data/www/` contains web interface files (generated by `npx gulp`)
- You can add other subdirectories to `data/` for application configs, logs, etc.
- The entire `data/` directory gets packed into a LittleFS image and flashed to the storage partition

### 5. Configure Serial Port (Optional)

The default serial port is `/dev/ttyACM0` with baud rate `460800`.

On Linux, ensure your user is in the `dialout` or `uucp` group:
```bash
sudo usermod -a -G dialout $USER  # Debian/Ubuntu
sudo usermod -a -G uucp $USER     # Arch/Manjaro
```

Log out and back in for group changes to take effect.

### 6. Build and Flash Firmware

Once everything is configured, you can build and flash:

```bash
idf.py build
idf.py -p /dev/ttyACM0 flash
```

**Monitor serial output:**
```bash
idf.py -p /dev/ttyACM0 monitor
```

Or combine all steps:
```bash
idf.py build flash monitor
```

### 7. Using the utility.sh Script (Recommended)

The `utility.sh` script provides a streamlined workflow for building and flashing both firmware and filesystem with automatic incremental updates.

**Basic usage:**
```bash
./utility.sh build              # Build firmware + flash filesystem (incremental)
./utility.sh flash              # Flash firmware only
./utility.sh flash-fs           # Flash filesystem only
./utility.sh flash-fs --force   # Force flash filesystem (ignore cache)
./utility.sh verify             # Verify device boot status
```

**Complete workflow:**
```bash
npx gulp                        # Build web assets
./utility.sh build              # Build firmware, flash filesystem if needed, reset device
```

**Features:**
- Incremental filesystem flashing - only flashes when files in `data/` change
- Automatic device reset and boot verification
- Reads partition table from compiled binary
- Flash marker tracking (`.littlefs_flashed`) for efficient rebuilds
- Configurable via environment variables (PORT, BAUD, CHIP)

**Environment variables:**
```bash
PORT=/dev/ttyUSB0 ./utility.sh build    # Use different serial port
BAUD=115200 ./utility.sh build          # Use different baud rate
CHIP=esp32s3 ./utility.sh build         # Set chip type
```

## Project Structure

```
radio-wazoo/
├── main/                   # Application code
│   ├── main.c             # Entry point
│   └── CMakeLists.txt
├── components/            # Custom ESP-IDF components
│   ├── webserver/        # HTTP server
│   └── access_point/     # WiFi AP
├── src/
│   ├── www/              # Web interface source files (editable)
│   └── settings/         # Application settings (CSV)
├── data/                 # Filesystem root (flashed to device)
│   └── www/              # Processed web files (generated by npx gulp)
├── build/                # Build artifacts (generated)
│   ├── littlefs.bin      # Filesystem image (generated)
│   └── .littlefs_flashed # Flash marker for incremental builds
├── partitions*.csv       # Partition table templates
├── sdkconfig.defaults*   # ESP-IDF configuration
├── utility.sh            # Build and flash automation script
├── gulpfile.js           # Build automation (Gulp)
├── package.json          # Node.js dependencies
└── package-lock.json     # Dependency lock file
```

**Key directories:**
- `src/www/` - Edit web files here (HTML, SCSS, JS, images)
- `data/www/` - Generated from `src/www/` via `npx gulp` (ready for ESP32)
- `data/` - Root of device filesystem (entire directory is flashed)

## Technologies

**Frontend:**
- **CSS**: PicoCSS 2.1.1 (semantic, class-less framework)
- **JavaScript**: Alpine.js 3.15.0 (reactive framework)
- **State Persistence**: @alpinejs/persist 3.15.0 (localStorage integration)
- **Build**: Gulp 5.0.1, esbuild (ESM/ES2017), Sass

**Backend:**
- **Framework**: ESP-IDF v5.0+
- **Target**: ESP32, ESP32-S2, ESP32-S3, ESP32-C3
- **Server**: Custom HTTP server component
- **Filesystem**: LittleFS (~133KB web assets)

## Features

### Web Server

The custom HTTP server component provides:

- **Static file serving** - Wildcard URI matching for assets (`/assets/*`)
- **Chunked transfer** - Efficient streaming of large files (1KB chunks)
- **Content-type detection** - Automatic MIME type detection for:
  - HTML, CSS, JavaScript
  - JSON
  - Images (PNG, JPG, SVG, ICO)
- **Error handling** - JSON error responses with HTTP status codes
- **Memory efficient** - Stack-allocated buffers for chunked transfers

### Settings Framework

Application settings are managed via CSV files in `src/settings/`:

- `settings.default.csv` - Default configuration (Network SSID, Password, etc.)
- Settings can be extended for additional configuration options
- CSV format: `Scope, Name, Type, Value`

### WiFi Access Point

On boot, the device creates a WiFi access point:

- **Default SSID**: `RadioWazooAP`
- **Default IP**: `192.168.4.1`
- **Web interface**: Navigate to `http://192.168.4.1` after connecting

Connection details are displayed in serial monitor output on startup.
